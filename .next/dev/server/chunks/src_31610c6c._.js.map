{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":["file:///home/danudenny/Downloads/geogreen-mapper/src/lib/prisma.ts"],"sourcesContent":["import { PrismaPg } from '@prisma/adapter-pg';\nimport { Pool } from 'pg';\nimport { PrismaClient } from '../generated/prisma';\n\nconst prismaClientSingleton = () => {\n    const connectionString = process.env.DATABASE_URL;\n    const pool = new Pool({ connectionString });\n    const adapter = new PrismaPg(pool);\n\n    return new PrismaClient({ adapter });\n};\n\ndeclare global {\n    var prisma: undefined | ReturnType<typeof prismaClientSingleton>;\n}\n\nconst prisma = globalThis.prisma ?? prismaClientSingleton();\n\nexport default prisma;\n\nif (process.env.NODE_ENV !== 'production') globalThis.prisma = prisma;\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;;;;;;AAEA,MAAM,wBAAwB;IAC1B,MAAM,mBAAmB,QAAQ,GAAG,CAAC,YAAY;IACjD,MAAM,OAAO,IAAI,4GAAI,CAAC;QAAE;IAAiB;IACzC,MAAM,UAAU,IAAI,yKAAQ,CAAC;IAE7B,OAAO,IAAI,qJAAY,CAAC;QAAE;IAAQ;AACtC;AAMA,MAAM,SAAS,WAAW,MAAM,IAAI;uCAErB;AAEf,wCAA2C,WAAW,MAAM,GAAG"}},
    {"offset": {"line": 41, "column": 0}, "map": {"version":3,"sources":["file:///home/danudenny/Downloads/geogreen-mapper/src/app/api/export/%5Blayer%5D/route.ts"],"sourcesContent":["import prisma from '@/lib/prisma';\nimport { NextRequest, NextResponse } from 'next/server';\n\nconst TABLE_MAP: Record<string, string> = {\n    rtrw: 'public.pola_ruang_revisi_rtrw',\n    badau: 'public.pola_ruang_badau',\n    geopark: 'public.pola_ruang_geopark',\n    tanjung: 'public.pola_ruang_tanjung_kelayang',\n    'badau-net': 'public.jaringan_struktur_ruang_badau',\n    'geopark-net': 'public.jaringan_struktur_ruang_geopark',\n    'tanjung-net': 'public.jaringan_struktur_ruang_tanjung_kelayang',\n};\n\nexport async function GET(\n    req: NextRequest,\n    props: {\n        params: Promise<{ layer: string }>;\n    }\n) {\n    const params = await props.params;\n    const layer = params.layer;\n\n    const tableName = TABLE_MAP[layer];\n\n    if (!tableName) {\n        return new NextResponse('Invalid layer', { status: 404 });\n    }\n\n    try {\n        // Use $queryRawUnsafe to allow dynamic table name injection (whitelisted via TABLE_MAP)\n        // jsonb_build_object and related functions are used to construct the GeoJSON directly in the DB\n        // allowing for efficient streaming/retrieval of a single large JSON blob.\n        const sql = `\n            SELECT jsonb_build_object(\n                'type', 'FeatureCollection',\n                'features', COALESCE(jsonb_agg(\n                    jsonb_build_object(\n                        'type', 'Feature',\n                        'geometry', ST_AsGeoJSON(ST_Transform(geom, 4326))::jsonb,\n                        'properties', to_jsonb(t.*) - 'geom'\n                    )\n                ), '[]'::jsonb)\n            ) as geojson\n            FROM ${tableName} AS t\n        `;\n\n        const result = await prisma.$queryRawUnsafe(sql);\n        const geojson = (result as any)[0]?.geojson;\n\n        if (!geojson) {\n            return new NextResponse(\n                JSON.stringify({ type: 'FeatureCollection', features: [] }),\n                {\n                    status: 200,\n                    headers: {\n                        'Content-Type': 'application/geo+json',\n                    },\n                }\n            );\n        }\n\n        // Return as a downloadable file\n        const filename = `${layer}.geojson`;\n\n        return new NextResponse(JSON.stringify(geojson), {\n            status: 200,\n            headers: {\n                'Content-Type': 'application/geo+json',\n                'Content-Disposition': `attachment; filename=\"${filename}\"`,\n            },\n        });\n    } catch (error) {\n        console.error(`Error exporting layer ${layer}:`, error);\n        return new NextResponse(\n            JSON.stringify({\n                error: 'Failed to export layer',\n                details: String(error),\n            }),\n            { status: 500 }\n        );\n    }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;;;;;AAEA,MAAM,YAAoC;IACtC,MAAM;IACN,OAAO;IACP,SAAS;IACT,SAAS;IACT,aAAa;IACb,eAAe;IACf,eAAe;AACnB;AAEO,eAAe,IAClB,GAAgB,EAChB,KAEC;IAED,MAAM,SAAS,MAAM,MAAM,MAAM;IACjC,MAAM,QAAQ,OAAO,KAAK;IAE1B,MAAM,YAAY,SAAS,CAAC,MAAM;IAElC,IAAI,CAAC,WAAW;QACZ,OAAO,IAAI,gJAAY,CAAC,iBAAiB;YAAE,QAAQ;QAAI;IAC3D;IAEA,IAAI;QACA,wFAAwF;QACxF,gGAAgG;QAChG,0EAA0E;QAC1E,MAAM,MAAM,CAAC;;;;;;;;;;;iBAWJ,EAAE,UAAU;QACrB,CAAC;QAED,MAAM,SAAS,MAAM,iIAAM,CAAC,eAAe,CAAC;QAC5C,MAAM,UAAU,AAAC,MAAc,CAAC,EAAE,EAAE;QAEpC,IAAI,CAAC,SAAS;YACV,OAAO,IAAI,gJAAY,CACnB,KAAK,SAAS,CAAC;gBAAE,MAAM;gBAAqB,UAAU,EAAE;YAAC,IACzD;gBACI,QAAQ;gBACR,SAAS;oBACL,gBAAgB;gBACpB;YACJ;QAER;QAEA,gCAAgC;QAChC,MAAM,WAAW,GAAG,MAAM,QAAQ,CAAC;QAEnC,OAAO,IAAI,gJAAY,CAAC,KAAK,SAAS,CAAC,UAAU;YAC7C,QAAQ;YACR,SAAS;gBACL,gBAAgB;gBAChB,uBAAuB,CAAC,sBAAsB,EAAE,SAAS,CAAC,CAAC;YAC/D;QACJ;IACJ,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,CAAC,sBAAsB,EAAE,MAAM,CAAC,CAAC,EAAE;QACjD,OAAO,IAAI,gJAAY,CACnB,KAAK,SAAS,CAAC;YACX,OAAO;YACP,SAAS,OAAO;QACpB,IACA;YAAE,QAAQ;QAAI;IAEtB;AACJ"}}]
}