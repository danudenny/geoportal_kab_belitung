{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":["file:///home/danudenny/Downloads/geogreen-mapper/src/lib/prisma.ts"],"sourcesContent":["import { PrismaPg } from '@prisma/adapter-pg';\nimport { Pool } from 'pg';\nimport { PrismaClient } from '../generated/prisma';\n\nconst prismaClientSingleton = () => {\n    const connectionString = process.env.DATABASE_URL;\n    const pool = new Pool({ connectionString });\n    const adapter = new PrismaPg(pool);\n\n    return new PrismaClient({ adapter });\n};\n\ndeclare global {\n    var prisma: undefined | ReturnType<typeof prismaClientSingleton>;\n}\n\nconst prisma = globalThis.prisma ?? prismaClientSingleton();\n\nexport default prisma;\n\nif (process.env.NODE_ENV !== 'production') globalThis.prisma = prisma;\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;;;;;;AAEA,MAAM,wBAAwB;IAC1B,MAAM,mBAAmB,QAAQ,GAAG,CAAC,YAAY;IACjD,MAAM,OAAO,IAAI,4GAAI,CAAC;QAAE;IAAiB;IACzC,MAAM,UAAU,IAAI,yKAAQ,CAAC;IAE7B,OAAO,IAAI,qJAAY,CAAC;QAAE;IAAQ;AACtC;AAMA,MAAM,SAAS,WAAW,MAAM,IAAI;uCAErB;AAEf,wCAA2C,WAAW,MAAM,GAAG"}},
    {"offset": {"line": 41, "column": 0}, "map": {"version":3,"sources":["file:///home/danudenny/Downloads/geogreen-mapper/src/app/api/tiles/%5Blayer%5D/%5Bz%5D/%5Bx%5D/%5By%5D/route.ts"],"sourcesContent":["import prisma from '@/lib/prisma';\nimport { NextRequest, NextResponse } from 'next/server';\n\nconst TABLE_MAP: Record<string, string> = {\n    rtrw: 'public.pola_ruang_revisi_rtrw',\n    badau: 'public.pola_ruang_badau',\n    geopark: 'public.pola_ruang_geopark',\n    tanjung: 'public.pola_ruang_tanjung_kelayang',\n    'badau-net': 'public.jaringan_struktur_ruang_badau',\n    'geopark-net': 'public.jaringan_struktur_ruang_geopark',\n    'tanjung-net': 'public.jaringan_struktur_ruang_tanjung_kelayang',\n    'badau-infra': 'public.infrastruktur_struktur_ruang_badau',\n    'geopark-infra': 'public.infrastruktur_struktur_ruang_geopark',\n    'tanjung-infra': 'public.infrastruktur_struktur_ruang_tanjung_kelayang',\n};\n\nexport async function GET(\n    req: NextRequest,\n    props: {\n        params: Promise<{ layer: string; z: string; x: string; y: string }>;\n    }\n) {\n    const params = await props.params;\n\n    const layer = params.layer;\n    const z = parseInt(params.z);\n    const x = parseInt(params.x);\n    const y = parseInt(params.y);\n\n    if (isNaN(z) || isNaN(x) || isNaN(y)) {\n        return new NextResponse('Invalid coordinates', { status: 400 });\n    }\n\n    const tableName = TABLE_MAP[layer];\n    if (!tableName) {\n        return new NextResponse('Invalid layer', { status: 404 });\n    }\n\n    try {\n        // Use Prisma.raw to safely inject the table name from our allowlist\n        // Use $queryRawUnsafe to allow dynamic table name injection\n        // TABLE_MAP ensures tableName is safe from injection\n        const sql = `\n            WITH mvtgeom AS (\n                SELECT\n                    ST_AsMVTGeom(\n                        ST_Force2D(ST_Transform(geom, 3857)),\n                        ST_TileEnvelope(${z}, ${x}, ${y})\n                    ) AS geom,\n                    *\n                FROM ${tableName}\n                WHERE ST_Intersects(\n                    ST_Force2D(ST_Transform(geom, 3857)),\n                    ST_TileEnvelope(${z}, ${x}, ${y})\n                )\n            )\n            SELECT ST_AsMVT(mvtgeom.*) AS mvt FROM mvtgeom;\n        `;\n\n        const query = await prisma.$queryRawUnsafe(sql);\n\n        // The result of $queryRaw is an array of objects\n        const tile = (query as any)[0]?.mvt;\n\n        if (!tile) {\n            return new NextResponse(null, { status: 204 });\n        }\n\n        return new NextResponse(tile, {\n            headers: {\n                'Content-Type': 'application/vnd.mapbox-vector-tile',\n                'Cache-Control': 'public, max-age=3600, s-maxage=3600',\n            },\n        });\n    } catch (error) {\n        console.error(`Error serving tile for layer ${layer}:`, error);\n        return new NextResponse(\n            JSON.stringify({\n                error: String(error),\n                stack: (error as Error).stack,\n            }),\n            { status: 500 }\n        );\n    }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;;;;;AAEA,MAAM,YAAoC;IACtC,MAAM;IACN,OAAO;IACP,SAAS;IACT,SAAS;IACT,aAAa;IACb,eAAe;IACf,eAAe;IACf,eAAe;IACf,iBAAiB;IACjB,iBAAiB;AACrB;AAEO,eAAe,IAClB,GAAgB,EAChB,KAEC;IAED,MAAM,SAAS,MAAM,MAAM,MAAM;IAEjC,MAAM,QAAQ,OAAO,KAAK;IAC1B,MAAM,IAAI,SAAS,OAAO,CAAC;IAC3B,MAAM,IAAI,SAAS,OAAO,CAAC;IAC3B,MAAM,IAAI,SAAS,OAAO,CAAC;IAE3B,IAAI,MAAM,MAAM,MAAM,MAAM,MAAM,IAAI;QAClC,OAAO,IAAI,gJAAY,CAAC,uBAAuB;YAAE,QAAQ;QAAI;IACjE;IAEA,MAAM,YAAY,SAAS,CAAC,MAAM;IAClC,IAAI,CAAC,WAAW;QACZ,OAAO,IAAI,gJAAY,CAAC,iBAAiB;YAAE,QAAQ;QAAI;IAC3D;IAEA,IAAI;QACA,oEAAoE;QACpE,4DAA4D;QAC5D,qDAAqD;QACrD,MAAM,MAAM,CAAC;;;;;wCAKmB,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE;;;qBAGnC,EAAE,UAAU;;;oCAGG,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE;;;;QAI5C,CAAC;QAED,MAAM,QAAQ,MAAM,iIAAM,CAAC,eAAe,CAAC;QAE3C,iDAAiD;QACjD,MAAM,OAAO,AAAC,KAAa,CAAC,EAAE,EAAE;QAEhC,IAAI,CAAC,MAAM;YACP,OAAO,IAAI,gJAAY,CAAC,MAAM;gBAAE,QAAQ;YAAI;QAChD;QAEA,OAAO,IAAI,gJAAY,CAAC,MAAM;YAC1B,SAAS;gBACL,gBAAgB;gBAChB,iBAAiB;YACrB;QACJ;IACJ,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,CAAC,6BAA6B,EAAE,MAAM,CAAC,CAAC,EAAE;QACxD,OAAO,IAAI,gJAAY,CACnB,KAAK,SAAS,CAAC;YACX,OAAO,OAAO;YACd,OAAO,AAAC,MAAgB,KAAK;QACjC,IACA;YAAE,QAAQ;QAAI;IAEtB;AACJ"}}]
}